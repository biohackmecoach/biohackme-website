name: Security Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: |
          cd functions
          npm audit --audit-level=moderate || true

      - name: Check for vulnerable dependencies
        run: |
          npm audit --json > audit-results.json || true
          if [ -f audit-results.json ]; then
            vulnerabilities=$(jq '.metadata.vulnerabilities.total' audit-results.json)
            if [ "$vulnerabilities" -gt 0 ]; then
              echo "⚠️  Found $vulnerabilities vulnerable dependencies"
              npm audit
            fi
          fi

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check for Firebase config
        run: |
          if grep -r "VITE_FIREBASE" src/ --include="*.ts" --include="*.tsx" | grep -v "hardcoded\|[A-Za-z0-9]"; then
            echo "⚠️  Warning: Found potentially missing Firebase environment variables"
          fi

  firebase-functions-check:
    name: Firebase Functions Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Functions dependencies
        run: |
          cd functions
          npm ci

      - name: Build Functions
        run: |
          cd functions
          npm run build

      - name: Check for secrets in functions code
        run: |
          cd functions
          if grep -r "process\.env\." src/ --include="*.ts" | grep -E "(API_KEY|SECRET|PASSWORD|TOKEN)" | grep -v "MAILCHIMP_API_KEY\|MAILCHIMP_AUDIENCE_ID"; then
            echo "⚠️  Warning: Found potentially hardcoded secrets in functions"
            exit 1
          fi
